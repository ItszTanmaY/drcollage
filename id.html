<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Registration Portal</title>

    <script src="https://cdn.tailwindcss.com"></script>
        <link rel="icon" type="image/png" href="study.ico">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&display=swap');
        
        body {
            font-family: 'Montserrat', sans-serif; 
            font-size: 20px; /* Base font size */
            background-color: #f0f4f8; 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

         body::before {
            content: '';
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('imggen1.png'); 
            background-size: cover;
            background-position: center;
            opacity: 0.7; 
            z-index: -1; 
            transition: opacity 0.6s ease-in-out;
        }

        .form-card {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(0, 0, 0, 0.05);
            background: radial-gradient(ellipse at center, #3b83f6af, #1e3b8ad8);
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
        }
        
        /* Style for inputs - FIX: Explicit dark text and border-2 for constant visibility */
        input:not([type="file"]), select, textarea {
            /* Guaranteed dark text and clear border */
            border: 2px solid #9ca3af; 
            background-color: #f9fafb; 
            color: #1f2937; /* FIX: Dark text color for visibility inside the input box */
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            width: 100%; 
            box-sizing: border-box; 
            box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.06); 
            transition: all 0.2s ease;
            font-size: 1.125rem; /* text-lg equivalent */
        }

        /* Ensure dropdown option text is clearly visible */
        select option {
            color: #1f2937; 
            background-color: white; 
        }
        
        /* Focus state for inputs */
        input:focus, select:focus, textarea:focus {
             outline: none;
             border-color: #4f46e5; 
             box-shadow: 0 0 4px 0px rgba(45, 212, 190, 0.144), 0 0 0 1px rgba(0,0,0,0.05); 
        }
        
        #photo-upload {
            display: none;
        }

        .decorative-banner {
            background: linear-gradient(135deg, #da8282 0%, #a55dbb 100%); 
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.4); 
        }

        .view-transition {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 sm:p-8">

    <div class="form-card max-w-6xl w-full rounded-2xl overflow-hidden">
        
        <div class="decorative-banner p-6 sm:p-8 text-center flex flex-col items-center justify-center">
            <svg class="w-12 h-12 sm:w-16 sm:h-16 text-white mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.201 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.799 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.799 5 16.5 5c1.701 0 3.332.477 4.5 1.253v13C19.832 18.477 18.201 18 16.5 18s-3.332.477-4.5 1.253"></path>
            </svg>
            <h1 class="text-2xl sm:text-3xl font-extrabold text-white tracking-wide">
                STUDENT IDENTITY PORTAL
            </h1>
        </div>

        <div id="app-container" class="p-6 sm:p-10 text-white"> 
            <div class="text-center text-gray-200 p-8">Loading application views...</div>
        </div>

        <div id="message-box" class="mx-6 sm:mx-10 mb-6 p-4 rounded-lg text-center hidden" role="alert"></div>

    </div>

    <div id="view-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg transform scale-95 transition-all duration-300">
            <h3 class="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">Application Details</h3>
            <div id="modal-content" class="space-y-2 text-gray-700">
            </div>
            <button onclick="document.getElementById('view-modal').classList.add('hidden')" class="mt-6 w-full py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-200">Close</button>
        </div>
    </div>

    <script>
        
        let applications = [];
        let viewState = 'dashboard';
        let editingApplication = null; 
        
        const appContainer = document.getElementById('app-container');
        const messageBox = document.getElementById('message-box');
        const STORAGE_KEY = 'simple_student_registration_data';

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            return new Date(timestamp).toLocaleString();
        }

        // --- LOCAL STORAGE DATA MANAGEMENT ---
        
        function loadDataFromStorage() {
            try {
                window.crypto = window.crypto || { randomUUID: () => Math.random().toString(36).substring(2) + Date.now().toString(36) };
                
                const storedData = localStorage.getItem(STORAGE_KEY);
                applications = storedData ? JSON.parse(storedData) : [];
            } catch (error) {
                console.error("Error loading data from localStorage:", error);
                applications = [];
            }
            applications.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            renderApp();
        }

        function saveDataToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(applications));
            } catch (error) {
                console.error("Error saving data to localStorage:", error);
                showMessage('Error saving data locally. Storage may be full.', 'bg-red-100', 'text-red-700', 'border border-red-300');
            }
        }

        function saveApplication(data) {
            try {
                const dataToSave = { ...data };
                delete dataToSave['photo-upload']; 
                
                if (data.id) {
                    const index = applications.findIndex(app => app.id === data.id);
                    if (index !== -1) {
                        const createdAt = applications[index].createdAt;
                        applications[index] = { 
                            ...dataToSave, 
                            createdAt: createdAt,
                            updatedAt: Date.now() 
                        };
                        showMessage('Application updated successfully!', 'bg-yellow-100', 'text-yellow-700', 'border border-yellow-300');
                    }
                } else {
                    const newApp = { 
                        ...dataToSave, 
                        id: crypto.randomUUID(),
                        createdAt: Date.now() 
                    };
                    applications.unshift(newApp); 
                    showMessage('New application submitted successfully!', 'bg-green-100', 'text-green-700', 'border border-green-300');
                }

                saveDataToStorage();
                editingApplication = null;
                changeView('list');

            } catch (error) {
                console.error("Error saving document: ", error);
                showMessage('Error saving application. See console for details.', 'bg-red-100', 'text-red-700', 'border border-red-300');
            }
        }

        function deleteApplication(id) {
            if (!confirm('Are you sure you want to delete this application?')) return; 

            const initialLength = applications.length;
            applications = applications.filter(app => app.id !== id);
            
            if (applications.length < initialLength) {
                saveDataToStorage();
                showMessage('Application deleted.', 'bg-red-100', 'text-red-700', 'border border-red-300');
                renderApp();
            }
        }

        // --- EXPORT FUNCTIONS ---

        function downloadCSV() {
            if (applications.length === 0) {
                showMessage('No applications available to download.', 'bg-yellow-100', 'text-yellow-700', 'border border-yellow-300');
                return;
            }

            const headers = ["ID", "Registration No.", "Full Name", "Standard", "Division", "Date of Birth", "Mobile No.", "Academic Year", "Address", "Submitted At"];
            const keys = ["id", "reg-no", "full-name", "std", "div", "dob", "mob", "year", "address", "createdAt"];
            
            const csvRows = [];
            csvRows.push(headers.join(',')); 

            for (const app of applications) {
                const values = keys.map(key => {
                    let value = app[key];
                    if (key === 'createdAt' || key === 'updatedAt') {
                        value = formatTimestamp(value); 
                    } else if (!value) {
                        value = '';
                    }
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            }

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `student_applications_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('CSV download started successfully.', 'bg-blue-100', 'text-blue-700', 'border border-blue-300');
        }

        function downloadPDF(appId) {
            viewApplicationDetails(appId); // Ensure modal content is populated
            setTimeout(() => { // Give browser time to render modal
                const modal = document.getElementById('view-modal');
                const closeBtn = modal.querySelector('button');
                
                // Hide close button during print
                closeBtn.style.display = 'none';

                // Print the modal content directly
                window.print();

                // Restore close button
                closeBtn.style.display = 'block';
                document.getElementById('view-modal').classList.add('hidden');
                showMessage('PDF generation requested.', 'bg-blue-100', 'text-blue-700', 'border border-blue-300');
            }, 100);
        }

        function downloadPlainText(appId) {
            const app = applications.find(a => a.id === appId);
            if (!app) return;

            const textContent = `
--- STUDENT APPLICATION DETAILS ---
Full Name:        ${app['full-name']}
Registration No:  ${app['reg-no']}
Date of Birth:    ${app.dob}
Academic Year:    ${app.year}
Standard (STD):   ${app.std}
Division (DIV):   ${app.div}
Mobile No.:       ${app.mob}
Full Address:     ${app.address}

Submitted On:     ${formatTimestamp(app.createdAt)}
--- END OF FILE ---
            `.trim();

            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${app['reg-no']}_application.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('Plain Text (.txt) download started successfully.', 'bg-blue-100', 'text-blue-700', 'border border-blue-300');
        }

        // --- UI & RENDERING ---

        function changeView(newView, application = null) {
            viewState = newView;
            editingApplication = application;
            renderApp();
        }

        function showMessage(text, bgColor, textColor, borderColor) {
            messageBox.textContent = text;
            messageBox.className = `mx-6 sm:mx-10 mb-6 p-4 rounded-lg text-center font-semibold shadow-md ${bgColor} ${textColor} ${borderColor}`;
            messageBox.classList.remove('hidden');
            
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // --- DASHBOARD VIEW ---
        function renderDashboard() {
            return `
                <div class="space-y-8 text-center">
                    <p class="text-3xl font-bold text-white">Welcome! Choose an action below.</p>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <button onclick="changeView('form')" class="py-5 px-4 rounded-xl shadow-lg text-xl font-bold text-white bg-blue-400 hover:bg-blue-500 transition duration-300 transform hover:scale-[1.03] hover:shadow-xl">
                            <span class="inline-block mr-2 text-2xl">üìù</span> New Application
                        </button>
                        <button onclick="changeView('list')" class="py-5 px-4 rounded-xl shadow-lg text-xl font-bold text-white bg-teal-600 hover:bg-teal-700 transition duration-300 transform hover:scale-[1.03] hover:shadow-xl">
                            <span class="inline-block mr-2 text-2xl">üìã</span> View Applications (${applications.length})
                        </button>
                    </div>
                </div>
            `;
        }

        // --- APPLICATION LIST VIEW ---
        function renderApplicationList() {
            // Function to filter and render list items
            const filterAndRenderList = (searchTerm = '') => {
                const searchLower = searchTerm.toLowerCase().trim();
                
                const filteredApplications = applications.filter(app => {
                    if (searchLower === '') return true;
                    
                    const name = app['full-name']?.toLowerCase() || '';
                    const regNo = app['reg-no']?.toLowerCase() || '';
                    
                    return name.includes(searchLower) || regNo.includes(searchLower);
                });

                const appListHtml = filteredApplications.length === 0 
                    ? '<p class="text-center text-gray-200 py-10">No matching applications found.</p>'
                    : filteredApplications.map(app => `
                        <div class="flex items-center justify-between p-4 bg-gray-50 border border-gray-100 rounded-xl shadow-md hover:shadow-lg hover:bg-white transition duration-200">
                            <div class="flex-1 min-w-0">
                                <p class="text-xl font-semibold text-gray-800 truncate">${app['full-name']}</p>
                                <p class="text-base text-gray-500">Reg. No: ${app['reg-no']} | Class: ${app.std} / ${app.div}</p>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <div class="relative group">
                                    <button onclick="viewApplicationDetails('${app.id}')" class="p-2 text-indigo-600 hover:text-indigo-800 transition duration-150 rounded-full hover:bg-indigo-100" title="View Details">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    </button>
                                    <div class="absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded-lg shadow-lg z-10 opacity-0 group-hover:opacity-100 transition duration-200 pointer-events-none group-hover:pointer-events-auto transform translate-y-1 group-hover:translate-y-0">
                                        <div class="py-1">
                                            <a href="#" onclick="event.preventDefault(); downloadPDF('${app.id}')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Download PDF</a>
                                            <a href="#" onclick="event.preventDefault(); downloadPlainText('${app.id}')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Download TXT</a>
                                        </div>
                                    </div>
                                </div>
                                
                                <button onclick="changeView('form', ${JSON.stringify(app).replace(/"/g, '&quot;')})" class="p-2 text-teal-600 hover:text-teal-800 transition duration-150 rounded-full hover:bg-teal-100" title="Edit">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                </button>
                                <button onclick="deleteApplication('${app.id}')" class="p-2 text-red-600 hover:text-red-800 transition duration-150 rounded-full hover:bg-red-100" title="Delete">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                    `).join('');
                
                document.getElementById('application-list').innerHTML = appListHtml;
            };

            // HTML Structure for the list view including the new search bar
            const listHtml = `
                <div class="space-y-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center pb-4 border-b border-gray-200 gap-4">
                        <button onclick="changeView('dashboard')" class="text-white hover:text-gray-200 flex items-center transition duration-200 text-xl">
                            <svg class="w-6 h-6 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            Back to Dashboard
                        </button>
                        <button onclick="downloadCSV()" class="flex items-center py-2 px-6 bg-green-500 text-white rounded-lg font-semibold shadow-md hover:bg-green-600 transition duration-200 text-xl">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Download Excel (${applications.length})
                        </button>
                    </div>
                    
                    <h2 class="text-4xl font-bold text-white">Submitted Applications</h2>

                    <div class="relative">
                        <input type="text" id="search-input" oninput="window.handleSearch(this.value)" 
                               placeholder="Search by Full Name or Registration No."
                               class="w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl shadow-inner focus:border-indigo-500 transition duration-200 text-lg"
                        >
                        <svg class="w-6 h-6 text-gray-500 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>

                    <div id="application-list" class="space-y-3">
                    </div>
                </div>
            `;
            
            // Set HTML and immediately render the full list
            setTimeout(() => filterAndRenderList(''), 0); 
            
            window.handleSearch = filterAndRenderList;

            return listHtml;
        }
        
        // --- FORM VIEW (Modified to handle Edit/New) ---
        function renderRegistrationForm() {
            const isEditing = editingApplication !== null;
            const formTitle = isEditing ? 'Edit Application Details' : 'New Student Application';
            const submitText = isEditing ? 'Update Registration' : 'Submit Final Registration';
            
            return `
                <div class="space-y-8">
                    <div class="flex justify-between items-center pb-4 border-b border-gray-200">
                        <button onclick="changeView('dashboard')" class="text-white hover:text-gray-200 flex items-center transition duration-200 text-xl">
                            <svg class="w-6 h-6 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            Back
                        </button>
                    </div>

                    <h2 class="text-3xl font-bold text-white">${formTitle}</h2>
                    
                    <form id="registration-form" class="space-y-8">
                        <input type="hidden" id="app-id" name="id" value="${isEditing ? editingApplication.id : ''}">

                        <div class="flex flex-col items-center justify-center space-y-4 border-b border-gray-200 pb-8">
                            <label for="photo-upload" class="block text-white font-semibold text-xl">Upload Student Photo (Optional in Edit Mode)</label>
                            
                            <div id="photo-preview" class="w-36 h-36 rounded-full bg-gray-100 border-4 border-indigo-500 flex items-center justify-center overflow-hidden cursor-pointer hover:border-teal-400 transition duration-300 shadow-lg" onclick="document.getElementById('photo-upload').click()">
                                <svg id="placeholder-icon" class="w-14 h-14 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <img id="uploaded-image" src="#" alt="Photo Preview" class="hidden w-full h-full object-cover">
                            </div>
                            
                            <input type="file" id="photo-upload" accept="image/*" ${isEditing ? '' : 'required'}>
                            <label for="photo-upload" class="cursor-pointer px-8 py-3 bg-teal-500 hover:bg-teal-600 text-white font-bold rounded-full transition duration-300 shadow-xl shadow-teal-500/40 text-xl">
                                Choose Photo
                            </label>
                            <p class="text-sm text-gray-200 mt-1">${isEditing ? 'Note: Photo remains unchanged unless a new one is uploaded.' : 'Required for new application.'}</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            
                            <div>
                                <label for="full-name" class="block text-xl font-medium text-white mb-2">Full Name</label>
                                <input type="text" id="full-name" name="full-name" required value="${isEditing ? (editingApplication['full-name'] || '') : ''}" class="w-full text-lg">
                            </div>

                            <div>
                                <label for="reg-no" class="block text-xl font-medium text-white mb-2">Registration No. (REG.NO.)</label>
                                <input type="text" id="reg-no" name="reg-no" required value="${isEditing ? (editingApplication['reg-no'] || '') : ''}" class="w-full text-lg">
                            </div>

                            <div>
                                <label for="dob" class="block text-xl font-medium text-white mb-2">Date of Birth (D.O.B)</label>
                                <input type="date" id="dob" name="dob" required value="${isEditing ? (editingApplication.dob || '') : ''}" class="w-full text-lg">
                            </div>
                            
                            <div>
                                <label for="year" class="block text-xl font-medium text-white mb-2">Academic Year (YEAR)</label>
                                <input type="text" id="year" name="year" pattern="\\d{4}-\\d{4}" placeholder="e.g., 2024-2025" required value="${isEditing ? (editingApplication.year || '') : ''}" class="w-full text-lg">
                                <p class="text-sm text-gray-200 mt-1">Format: YYYY-YYYY</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">

                            <div>
                                <label for="std" class="block text-xl font-medium text-white mb-2">Standard (STD)</label>
                                <select id="std" name="std" required class="w-full text-gray-900 text-lg">
                                    <option value="" ${!isEditing || !editingApplication.std ? 'selected' : ''} disabled>Select Class (11 or 12)</option>
                                    <option value="11" ${isEditing && editingApplication.std === '11' ? 'selected' : ''}>11</option>
                                    <option value="12" ${isEditing && editingApplication.std === '12' ? 'selected' : ''}>12</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="div" class="block text-xl font-medium text-white mb-2">Division (DIV)</label>
                                <select id="div" name="div" required class="w-full text-gray-900 text-lg">
                                    <option value="" ${!isEditing || !editingApplication.div ? 'selected' : ''} disabled>Select Div</option>
                                    <option value="A" ${isEditing && editingApplication.div === 'A' ? 'selected' : ''}>A</option>
                                    <option value="B" ${isEditing && editingApplication.div === 'B' ? 'selected' : ''}>B</option>
                                    <option value="C" ${isEditing && editingApplication.div === 'C' ? 'selected' : ''}>C</option>
                                    <option value="D" ${isEditing && editingApplication.div === 'D' ? 'selected' : ''}>D</option>
                                </select>
                            </div>

                            <div>
                                <label for="mob" class="block text-xl font-medium text-white mb-2">Mobile No. (MOB)</label>
                                <input type="tel" id="mob" name="mob" pattern="[0-9]{10}" placeholder="10-digit number" required value="${isEditing ? (editingApplication.mob || '') : ''}" class="w-full text-lg">
                                <p class="text-sm text-gray-200 mt-1">Format: 10 digits only</p>
                            </div>
                        </div>

                        <div>
                            <label for="address" class="block text-xl font-medium text-white mb-2">Full Address (ADDRESS)</label>
                            <textarea id="address" name="address" rows="3" required class="w-full text-gray-900 text-lg">${isEditing ? (editingApplication.address || '') : ''}</textarea>
                        </div>

                        <div class="pt-6">
                            <button type="submit" class="w-full flex justify-center py-4 px-4 border border-transparent rounded-xl shadow-2xl text-2xl font-bold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-teal-400 focus:ring-opacity-50 transition duration-300 transform hover:scale-[1.005]">
                                ${submitText}
                            </button>
                        </div>

                    </form>
                </div>
            `;
        }

        function viewApplicationDetails(id) {
            const app = applications.find(a => a.id === id);
            if (!app) return;

            const modalContent = document.getElementById('modal-content');
            
            let dateSubmitted = formatTimestamp(app.createdAt);
            if (app.updatedAt) {
                 dateSubmitted = formatTimestamp(app.updatedAt) + ' (Updated)';
            }

            modalContent.innerHTML = `
                <div class="border-b pb-2 mb-2">
                    <p class="font-bold text-xl text-gray-900">${app['full-name']}</p>
                    <p class="text-base text-gray-500">Reg. No: ${app['reg-no']}</p>
                </div>
                <p class="text-lg"><strong>Class:</strong> ${app.std} / ${app.div}</p>
                <p class="text-lg"><strong>Date of Birth:</strong> ${app.dob}</p>
                <p class="text-lg"><strong>Academic Year:</strong> ${app.year}</p>
                <p class="text-lg"><strong>Mobile No.:</strong> ${app.mob}</p>
                <p class="text-lg"><strong>Address:</strong> ${app.address}</p>
                <p class="text-sm pt-2">Submitted On: ${dateSubmitted}</p>
                <p class="text-sm text-indigo-500 pt-2">Photo file name is not stored for security reasons.</p>
            `;

            document.getElementById('view-modal').classList.remove('hidden');
        }


        // --- MAIN RENDER FUNCTION ---
        function renderApp() {
            try {
                appContainer.classList.add('view-transition');
                appContainer.style.opacity = '0';
                
                let htmlContent = '';

                switch (viewState) {
                    case 'dashboard':
                        htmlContent = renderDashboard();
                        break;
                    case 'form':
                        htmlContent = renderRegistrationForm();
                        break;
                    case 'list':
                        htmlContent = renderApplicationList();
                        break;
                    default:
                        htmlContent = renderDashboard();
                }

                setTimeout(() => {
                    appContainer.innerHTML = htmlContent;
                    appContainer.style.opacity = '1';
                    
                    if (viewState === 'form') {
                        attachFormListeners();
                    }
                }, 300); 
            } catch (error) {
                console.error("Render error:", error);
                appContainer.innerHTML = `<div class="text-center text-red-500 p-8">A critical error occurred: ${error.message}. Check console.</div>`;
            }
        }

        function attachFormListeners() {
            const form = document.getElementById('registration-form');
            const fileInput = document.getElementById('photo-upload');
            const uploadedImage = document.getElementById('uploaded-image');
            const placeholderIcon = document.getElementById('placeholder-icon');

            fileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedImage.src = e.target.result;
                        uploadedImage.classList.remove('hidden');
                        placeholderIcon.classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    uploadedImage.src = '#';
                    uploadedImage.classList.add('hidden');
                    placeholderIcon.classList.remove('hidden');
                }
            });

            form.addEventListener('submit', function(event) {
                event.preventDefault(); 
                
                const formData = new FormData(form);
                const data = {};
                for (const [key, value] of formData.entries()) {
                   data[key] = value;
                }
                
                if (!data.id && !fileInput.files[0]) {
                    showMessage('Please upload a student photo for a new application.', 'bg-red-100', 'text-red-700', 'border border-red-300');
                    return;
                }

                saveApplication(data);
            });
        }

        window.changeView = changeView;
        window.deleteApplication = deleteApplication;
        window.downloadCSV = downloadCSV;
        window.downloadPDF = downloadPDF;
        window.downloadPlainText = downloadPlainText;
        window.viewApplicationDetails = viewApplicationDetails;


        document.addEventListener('DOMContentLoaded', loadDataFromStorage);
    </script>
</body>
</html>